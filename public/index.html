<!doctype html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <title>CRUD Items</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
        body {
            font-family: system-ui, sans-serif;
            margin: 24px;
            max-width: 860px
        }

        h1 {
            margin-bottom: 8px
        }

        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 10px
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left
        }

        form {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: 8px;
            margin: 12px 0
        }

        input[type="number"] {
            width: 100%
        }

        .row {
            display: flex;
            gap: 8px;
            align-items: center
        }

        .muted {
            color: #666;
            font-size: 12px
        }

        button {
            cursor: pointer
        }
    </style>
</head>

<body>
    <h1>Inventario</h1>
    <p class="muted">Demostración: listar, ver detalle, crear, editar y eliminar.</p>

    <div class="row">
        <input id="detailId" type="number" placeholder="ID para detalle/edición" />
        <button onclick="getOne()">Consultar individual</button>
    </div>

    <form onsubmit="createItem(event)">
        <input id="name" placeholder="Nombre" required />
        <input id="price" type="number" step="0.01" placeholder="Precio" required />
        <input id="stock" type="number" step="1" placeholder="Stock" value="0" />
        <button>Agregar</button>
    </form>

    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Nombre</th>
                <th>Precio</th>
                <th>Stock</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody id="tbody"></tbody>
    </table>

    <script>
        const api = (p = '') => fetch(location.origin + '/api' + p);

        async function refresh() {
            const res = await api('/items');
            const data = await res.json();
            const tbody = document.getElementById('tbody');
            tbody.innerHTML = data.map(i => `
        <tr>
          <td>${i.id}</td>
          <td>${i.name}</td>
          <td>$${i.price}</td>
          <td>${i.stock}</td>
          <td>
            <button onclick="prefill(${i.id}, '${escapeHtml(i.name)}', ${i.price}, ${i.stock})">Editar</button>
            <button onclick="del(${i.id})">Eliminar</button>
          </td>
        </tr>
      `).join('');
        }

        function prefill(id, name, price, stock) {
            document.getElementById('detailId').value = id;
            document.getElementById('name').value = unescapeHtml(name);
            document.getElementById('price').value = price;
            document.getElementById('stock').value = stock;
        }

        async function getOne() {
            const id = document.getElementById('detailId').value;
            if (!id) return alert('Indica un ID');
            const res = await api('/items/' + id);
            if (!res.ok) return alert('No encontrado');
            const i = await res.json();
            alert(`ID: ${i.id}\nNombre: ${i.name}\nPrecio: $${i.price}\nStock: ${i.stock}`);
        }

        async function createItem(e) {
            e.preventDefault();
            if (document.getElementById('detailId').value) return; // <- evita el POST cuando editas
            const payload = bodyFromInputs();
            const res = await fetch('/api/items', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (res.ok) { e.target.reset(); await refresh(); } else alert('Error al crear');
        }


        async function del(id) {
            if (!confirm('¿Eliminar?')) return;
            const res = await fetch('/api/items/' + id, { method: 'DELETE' });
            if (res.ok) refresh(); else alert('No encontrado');
        }

        // Edita si hay ID en detailId
        document.getElementById('detailId').addEventListener('change', async (e) => {
            const id = e.target.value;
            if (!id) return;
            const res = await api('/items/' + id);
            if (res.ok) {
                const i = await res.json();
                prefill(i.id, i.name, i.price, i.stock);
            }
        });

        // Doble función del botón "Agregar" si hay ID → actualizar
        document.querySelector('form').addEventListener('submit', async (e) => {
            if (!document.getElementById('detailId').value) return; // createItem ya cubrirá
            e.preventDefault();
            const id = document.getElementById('detailId').value;
            const payload = bodyFromInputs();
            const res = await fetch('/api/items/' + id, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (res.ok) { document.getElementById('detailId').value = ''; e.target.reset(); refresh(); }
        });

        function bodyFromInputs() {
            return {
                name: document.getElementById('name').value.trim(),
                price: Number(document.getElementById('price').value),
                stock: Number(document.getElementById('stock').value || 0)
            };
        }

        function escapeHtml(s) { return s.replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;').replaceAll('"', '&quot;').replaceAll("'", "&#039;") }
        function unescapeHtml(s) { return s.replaceAll('&lt;', '<').replaceAll('&gt;', '>').replaceAll('&quot;', '"').replaceAll('&#039;', "'").replaceAll('&amp;', '&') }

        refresh();
    </script>
</body>

</html>